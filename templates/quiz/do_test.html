{% extends "base.html" %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/quiz_pro.css') }}">

<style>
    /* NgƒÉn ch·∫∑n h√†nh vi b√¥i ƒëen vƒÉn b·∫£n tr√™n to√†n b·ªô trang */
    body {
        -webkit-user-select: none; /* Safari */
        -moz-user-select: none; /* Firefox */
        -ms-user-select: none; /* IE10+/Edge */
        user-select: none; /* Standard */
    }
</style>

<div class="container-fluid bg-light min-vh-100 pb-5">
    <form action="{{ url_for('test.submit_test') }}" method="POST" id="quizForm">
        
        <div class="quiz-header-bar bg-white py-3 border-bottom" style="z-index: 1030;">
            <div class="container">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="m-0 fw-bold text-primary">ƒê·ªÅ √¥n t·∫≠p</h5>
                        <small class="text-muted">Th√≠ sinh: <span class="fw-bold">H·ªçc sinh</span></small>
                    </div>
                    <div class="d-flex align-items-center gap-3">
                        <div class="timer-box">
                            <i class="fas fa-clock"></i> <span id="timer" class="fw-bold">20:00</span>
                        </div>
                        <button type="button" class="btn btn-primary px-4 fw-bold shadow-sm" onclick="confirmSubmit()">
                            <i class="fas fa-paper-plane me-1"></i> N·ªòP B√ÄI
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div style="height: 100px;"></div>

        <div class="container mt-3">
            <div class="row">
                <div class="col-md-9">
                    {% for q in questions %}
                    <div class="card mb-4 shadow-sm border-0 question-card" id="quest-{{ q['Id'] }}">
                        <div class="card-body p-4">
                            <h4 class="fw-bold mb-3 text-dark">C√¢u {{ loop.index }}:</h4>
                            <p class="mb-3 fw-bold" style="font-size: 1.15rem;">{{ q['Content'] }}</p>
                            
                            <div class="options-text ms-2">
                                <p class="mb-2"><strong>A.</strong> {{ q['OptionA'] }}</p>
                                <p class="mb-2"><strong>B.</strong> {{ q['OptionB'] }}</p>
                                <p class="mb-2"><strong>C.</strong> {{ q['OptionC'] }}</p>
                                <p class="mb-2"><strong>D.</strong> {{ q['OptionD'] }}</p>
                            </div>

                            <div class="d-none">
                                <input type="radio" name="{{ q['Id'] }}" value="A" id="radio-{{ q['Id'] }}-A">
                                <input type="radio" name="{{ q['Id'] }}" value="B" id="radio-{{ q['Id'] }}-B">
                                <input type="radio" name="{{ q['Id'] }}" value="C" id="radio-{{ q['Id'] }}-C">
                                <input type="radio" name="{{ q['Id'] }}" value="D" id="radio-{{ q['Id'] }}-D">
                            </div>
                        </div>

                        <div class="card-footer quiz-footer text-white d-flex align-items-center p-3">
                            <div class="d-flex align-items-center text-white">
                                <span class="me-3 fw-bold small">CH·ªåN ƒê√ÅP √ÅN:</span>
                                <div class="d-flex gap-3">
                                    <button type="button" class="btn-circle" onclick="selectAnswer('{{ q['Id'] }}', 'A')">A</button>
                                    <button type="button" class="btn-circle" onclick="selectAnswer('{{ q['Id'] }}', 'B')">B</button>
                                    <button type="button" class="btn-circle" onclick="selectAnswer('{{ q['Id'] }}', 'C')">C</button>
                                    <button type="button" class="btn-circle" onclick="selectAnswer('{{ q['Id'] }}', 'D')">D</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <div class="col-md-3">
                    <div class="sidebar-sticky bg-white p-3 rounded shadow-sm border">
                        <h6 class="fw-bold text-uppercase mb-3 small text-muted border-bottom pb-2">M·ª•c l·ª•c c√¢u h·ªèi</h6>
                        
                        <div class="question-grid">
                            {% for q in questions %}
                            <a href="#quest-{{ q['Id'] }}" class="q-idx-btn" id="idx-{{ q['Id'] }}">
                                {{ loop.index }}
                            </a>
                            {% endfor %}
                        </div>

                        <div class="mt-4 small d-flex justify-content-between text-muted">
                            <div><span class="badge bg-warning me-1">&nbsp;</span> ƒê√£ l√†m</div>
                            <div><span class="badge border bg-light text-dark ms-2">&nbsp;</span> Ch∆∞a l√†m</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
    // üõ°Ô∏è PH·∫¶N 2: JS CH·ªêNG GIAN L·∫¨N (C·∫§P ƒê·ªò 1 - ƒê√É C√ì)
    
    // 1. Ch·∫∑n chu·ªôt ph·∫£i
    document.addEventListener('contextmenu', event => event.preventDefault());

    // 2. Ch·∫∑n ph√≠m t·∫Øt
    document.onkeydown = function(e) {
        if(e.keyCode == 123) return false; // F12
        if(e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) return false; // Ctrl+Shift+I
        if(e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) return false; // Ctrl+Shift+J
        if(e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) return false; // Ctrl+U
        if(e.ctrlKey && e.keyCode == 'C'.charCodeAt(0)) return false; // Ctrl+C
    }

    // üî• PH·∫¶N 3: JS CH·ªêNG GIAN L·∫¨N (C·∫§P ƒê·ªò 2 - M·ªöI TH√äM)
    // "B·∫ÆT QU·∫¢ TANG" CHUY·ªÇN TAB 
    
    let violationCount = 0; // Bi·∫øn ƒë·∫øm s·ªë l·∫ßn vi ph·∫°m
    const originalTitle = document.title; // L∆∞u ti√™u ƒë·ªÅ g·ªëc c·ªßa trang

    document.addEventListener("visibilitychange", function() {
        if (document.hidden) {
            // üö® S·ª∞ C·ªê: Ng∆∞·ªùi d√πng v·ª´a r·ªùi kh·ªèi tab thi (sang Facebook, Google...)
            violationCount++;
            
            // ƒê·ªïi ti√™u ƒë·ªÅ tab th√†nh c·∫£nh b√°o (ƒë·ªÉ h·ªçc sinh th·∫•y r√©n)
            document.title = "‚ö†Ô∏è C·∫¢NH B√ÅO: QUAY L·∫†I NGAY!";
            
            console.log(`Ph√°t hi·ªán gian l·∫≠n l·∫ßn th·ª©: ${violationCount}`);
            
        } else {
            // ‚úÖ Ng∆∞·ªùi d√πng v·ª´a quay l·∫°i tab thi
            document.title = originalTitle; // Tr·∫£ l·∫°i ti√™u ƒë·ªÅ c≈©
            
            // Hi·ªán b·∫£ng c·∫£nh b√°o ngay l·∫≠p t·ª©c
            alert(`‚õî C·∫¢NH B√ÅO GIAN L·∫¨N!\n\nH·ªá th·ªëng ph√°t hi·ªán b·∫°n ƒë√£ r·ªùi kh·ªèi m√†n h√¨nh thi ${violationCount} l·∫ßn.\n\nGi√°o vi√™n s·∫Ω ƒë∆∞·ª£c th√¥ng b√°o v·ªÅ h√†nh vi n√†y. N·∫øu vi ph·∫°m qu√° nhi·ªÅu, b√†i thi s·∫Ω b·ªã h·ªßy k·∫øt qu·∫£!`);
        }
    });

    // --- C√ÅC H√ÄM X·ª¨ L√ù B√ÄI THI (GI·ªÆ NGUY√äN) ---

    // 1. H√†m ch·ªçn ƒë√°p √°n
    function selectAnswer(questionId, option) {
        const radio = document.getElementById(`radio-${questionId}-${option}`);
        if(radio) radio.checked = true;

        const container = document.getElementById(`quest-${questionId}`);
        const buttons = container.querySelectorAll('.btn-circle');
        buttons.forEach(btn => btn.classList.remove('selected'));
        
        buttons.forEach(btn => {
            if(btn.innerText.trim() === option) btn.classList.add('selected');
        });

        const sidebarBtn = document.getElementById(`idx-${questionId}`);
        if(sidebarBtn) sidebarBtn.classList.add('done');
    }

    // 2. ƒê·ªìng h·ªì ƒë·∫øm ng∆∞·ª£c
    let timeSeconds = 20 * 60; 
    const timerDisplay = document.getElementById('timer');
    
    const countdown = setInterval(() => {
        if(timeSeconds <= 0) {
            clearInterval(countdown);
            alert("H·∫øt gi·ªù l√†m b√†i!");
            document.getElementById('quizForm').submit();
            return;
        }
        timeSeconds--;
        const m = Math.floor(timeSeconds / 60);
        const s = timeSeconds % 60;
        timerDisplay.innerText = `${m}:${s < 10 ? '0'+s : s}`;
        
        if(timeSeconds < 300) {
            timerDisplay.parentElement.style.backgroundColor = '#ffecec';
            timerDisplay.parentElement.classList.add('shake'); 
        }
    }, 1000);

    // 3. X√°c nh·∫≠n n·ªôp b√†i
    function confirmSubmit() {
        const total = {{ questions|length }};
        const done = document.querySelectorAll('.q-idx-btn.done').length;
        if(confirm(`B·∫°n ƒë√£ l√†m ${done}/${total} c√¢u. N·ªôp b√†i ngay?`)) {
            document.getElementById('quizForm').submit();
        }
    }
</script>
{% endblock %}